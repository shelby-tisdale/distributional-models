---
title: "Distributional Models for Adolescent Brain Development"
format: dashboard
server: shiny
theme: [custom.scss]
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: load-packages
#| warning: false
#| message: false
#| output: false
#| context: setup

library(tidyverse)
library(gt)
library(DT)
library(janitor)
library(shiny)
library(knitr)
library(kableExtra)
library(scales)
library(extrafont)
library(gamlss)
library(gamlss.ggplots)
library(plotly)
library(latex2exp)
library(ggseg)
library(patchwork)


theme_set(theme_minimal(base_size = 16, base_family = "Atkinson Hyperlegible"))


```

```{r}
#| label: load-and-prep-data
#| output: false
#| context: data
#| warning: false
#| message: false
#| cache: true

# labels for area variables
area_labels <- read_csv("~/Equitable Data Science REU/distributional-models/Area_Variable_Labels.csv") |>
  mutate(var_label = str_replace(var_label, "Cortical area in mm\\^", ""),
         var_label = str_replace(var_label, "2 of APARC ROI ", ""),
         var_label = str_replace(var_label, "lh-", "Left Hemisphere "),
         var_label = str_replace(var_label, "rh-", "Right Hemisphere "),
         var_label = str_replace(var_label, "cortical area in mm\\^2", ""),
         var_label = str_replace(var_label, "Total ", ""),
         var_label = str_to_lower(var_label))

data_dir <- 'C:/Users/queen/Box/ABCD Tabulated Data/5.1/core/'

# NOTE: must run entire code chunk
if(!is.null(data_dir)){
  setwd(data_dir)
}

# LOAD DATA
# Demographic variables and propensity weights
demog <- read.csv("abcd-general/abcd_p_demo.csv", na.strings = c("999", "777"))
# Age in months, Site ID (ABCD Study Design Variables), Family ID
study_covars <- read.csv("abcd-general/abcd_y_lt.csv")
# desikan atlas, cortical thickness
dat.mri = read.csv('imaging/mri_y_smr_thk_dsk.csv')
# desikan atlas, cortical surface area
dat.mri.area = read.csv('imaging/mri_y_smr_area_dsk.csv') #|>
  #select(src_subject_id, eventname, smri_area_cdk_total)

# basic cleaning for demographic variables
demog_clean <- demog |>
  # filter for events of interest
  filter(eventname %in% c("baseline_year_1_arm_1", "2_year_follow_up_y_arm_1",
                          "4_year_follow_up_y_arm_1")) |>
  # select broad demographics
  select(src_subject_id, eventname, starts_with("demo_brthdat_v2"), demo_sex_v2, race_ethnicity) |>
  mutate(
    # clean age variable
    age = case_when(
      eventname == "baseline_year_1_arm_1" ~ trunc(demo_brthdat_v2), # remove decimals 
      eventname %in% c("2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1") ~
        trunc(demo_brthdat_v2_l)),
    # broad race/ethnicity categories
    # will disaggregate in final analysis
    race_ethnicity = case_match(
      race_ethnicity,
      1 ~ "White",
      2 ~ "Black",
      3 ~ "Hispanic",
      4 ~ "Asian",
      5 ~ "Other"
    ),
    # recode sex variable
    sex = factor(demo_sex_v2),
    sex = fct_recode(
      sex,
      "Male" = "1",
      "Female" = "2",
      "Intersex-Male" = "3"
    ))

# create dataset for modeling
mri_data <- dat.mri |>
  full_join(dat.mri.area, by = join_by("eventname", "src_subject_id")) |>
  # join mri data to demographics
  right_join(demog_clean, by = join_by("eventname", "src_subject_id")) |>
  # join to study covariates
  left_join(study_covars, by = join_by("eventname", "src_subject_id")) |>
  # select variables of interest
  select(src_subject_id, eventname, age, sex, site_id_l, race_ethnicity, interview_age, contains("smri_thick"), contains("smri_area_cdk")) |>
  # remove irrelevant ages 
  filter(age < 16 & age > 8) |>
  mutate(interview_age = as.numeric(interview_age)) |>
  group_by(src_subject_id) |>
  # fill repeated demographic values
  mutate(sex = first(na.omit(sex)),
         race_ethnicity = first(na.omit(race_ethnicity)),
         src_subject_id = factor(src_subject_id),
         site_id_l = factor(site_id_l),
         race_ethnicity = factor(race_ethnicity)) |>
  ungroup()

area_vars <- area_labels$var_label

brain_data <- na.omit(mri_data)

# find all sex and race combinations for original data
brain_data <- brain_data |>
  filter(sex != "Intersex-Male") |>
  mutate(sex = factor(sex))

demog_combos <- brain_data |>
  mutate(race_ethnicity = as.character(race_ethnicity)) |>
  expand(sex, race_ethnicity)

male_all <- c("Male", "All")
female_all <- c("Female", "All")

demog_combos <- rbind(demog_combos, male_all, female_all)
sex <- demog_combos$sex
race_ethnicity <- demog

limits <- brain_data |> pivot_longer(
  cols = starts_with("smri_area"),
  names_to = "var_name",
  values_to = "values"
) |>
  group_by(var_name) |>
  summarize(
    min_value = min(values),
    max_value = max(values)
  )
  

demog_brain_combos <- expand.grid(
  sex = demog_combos$sex,
  race_ethnicity = demog_combos$race_ethnicity,
  brain_location = area_vars) |>
  left_join(area_labels, by = join_by(brain_location == var_label)) |>
  left_join(limits, by = join_by(var_name)) |>
  mutate(sex = factor(sex),
         race_ethnicity = factor(race_ethnicity),
         brain_location = factor(brain_location),
         min_value = as.numeric(min_value),
         max_value = as.numeric(max_value)) |>
  distinct()

demog_brain_combos <- as.matrix(demog_brain_combos)

brain_pictures <- brain_data |> 
  pivot_longer(cols = (smri_thick_cdk_banksstslh:smri_thick_cdk_trvtmrh), 
                names_to = "phenotype") |> 
  #add hemisphere classification 
  mutate(hemisphere = case_when( 
                                 grepl("lh", phenotype) ~ "left", 
                                 grepl("rh", phenotype) ~ "right", 
                                 .default = NA), 
          #use forcats to collapse regions 
         region = factor(phenotype), 
         region = fct_collapse(
           phenotype, 
          "pericalcarine" = c("smri_thick_cdk_pericclh",
                              "smri_thick_cdk_periccrh"),
          "caudal anterior cingulate" = c("smri_thick_cdk_cdacatelh",
                                          "smri_thick_cdk_cdacaterh"),
          "caudal middle frontal" = c("smri_thick_cdk_cdmdfrlh",
                                      "smri_thick_cdk_cdmdfrrh"),
          "cuneus" = c("smri_thick_cdk_cuneuslh",
                       "smri_thick_cdk_cuneusrh"),
          "entorhinal" = c("smri_thick_cdk_ehinallh",
                           "smri_thick_cdk_ehinalrh"),
          "fusiform" = c("smri_thick_cdk_fusiformlh",
                         "smri_thick_cdk_fusiformrh"),
          "inferior parietal" = c("smri_thick_cdk_ifpllh",
                                  "smri_thick_cdk_ifplrh"),
          "isthmus cingulate" = c("smri_thick_cdk_ihcatelh",
                                  "smri_thick_cdk_ihcaterh"),
          "lateral occipital" = c("smri_thick_cdk_locclh",
                                  "smri_thick_cdk_loccrh"),
          "lateral orbitofrontal" = c("smri_thick_cdk_lobfrlh",
                                      "smri_thick_cdk_lobfrrh"),
          "lingual" = c("smri_thick_cdk_linguallh",
                        "smri_thick_cdk_lingualrh"),
          "medial orbitofrontal" = c("smri_thick_cdk_mobfrlh",
                                     "smri_thick_cdk_mobfrrh"),
          "middle temporal" = c("smri_thick_cdk_mdtmlh",
                                "smri_thick_cdk_mdtmrh"),
          "parahippocampal" = c("smri_thick_cdk_parahpallh",
                                "smri_thick_cdk_parahpalrh"),
          "paracentral" = c("smri_thick_cdk_paracnlh",
                            "smri_thick_cdk_paracnrh"),
          "pars opercularis" = c("smri_thick_cdk_parsopclh",
                                 "smri_thick_cdk_parsopcrh"),
          "pars orbitalis" = c("smri_thick_cdk_parsobislh",
                               "smri_thick_cdk_parsobisrh"),
          "pars triangularis" = c("smri_thick_cdk_parstgrislh",
                                  "smri_thick_cdk_parstgrisrh"),
          "pericalcarine" = c("smri_thick_cdk_pericclh",
                              "smri_thick_cdk_periccrh"),
          "postcentral" = c("smri_thick_cdk_postcnlh",
                            "smri_thick_cdk_postcnrh"),
          "posterior cingulate" = c("smri_thick_cdk_ptcatelh",
                                    "smri_thick_cdk_ptcaterh"),
          "precentral" = c("smri_thick_cdk_precnlh",
                           "smri_thick_cdk_precnrh"),
          "precuneus" = c("smri_thick_cdk_pclh",
                          "smri_thick_cdk_pcrh"),
          "rostral anterior cingulate" = c("smri_thick_cdk_rracatelh",
                                           "smri_thick_cdk_rracaterh"),
          "rostral middle frontal" = c("smri_thick_cdk_rrmdfrlh",
                                       "smri_thick_cdk_rrmdfrrh"),
          "superior frontal" = c("smri_thick_cdk_sufrlh",
                                 "smri_thick_cdk_sufrrh"),
          "superior parietal" = c("smri_thick_cdk_supllh",
                                  "smri_thick_cdk_suplrh"),
          "superior temporal" = c("smri_thick_cdk_sutmlh",
                                  "smri_thick_cdk_sutmrh"),
          "supramarginal" = c("smri_thick_cdk_smlh",
                              "smri_thick_cdk_smrh"),
          "frontal pole" = c("smri_thick_cdk_frpolelh",
                             "smri_thick_cdk_frpolerh"),
          "temporal pole" = c("smri_thick_cdk_tmpolelh",
                              "smri_thick_cdk_tmpolerh"),
          "transverse temporal" = c("smri_thick_cdk_trvtmlh",
                                    "smri_thick_cdk_trvtmrh"),
          "insula" = c("smri_thick_cdk_insulalh",
                       "smri_thick_cdk_insularh"),
          "inferior temporal" = c("smri_thick_cdk_iftmlh",
                                  "smri_thick_cdk_iftmrh"),
          "bankssts" = c("smri_thick_cdk_banksstslh", 
                         "smri_thick_cdk_banksstsrh"),
          other_level = 'missing'
          ))

```

```{r}
#| label: subset-data-function
#| context: setup
#| output: false

# SUBSETS DATA BY FILTERING FOR UP TO 2 VARIABLES
# PREPS DATA FOR MODELING
# EX. SEX = "MALE" AND RACE = "BLACK"
subset_data <- function(
    # full dataset
    brain_data,
    # xvariable
    xcol,
    # yvariable
    ycol,
    # first variable to filter by
    filter_var1 = NULL,
    # value of first variable to filter for
    filter_val1 = NULL,
    # second variable to filter by
    filter_var2 = NULL,
    # value of second variable to filter for
    filter_val2 = NULL
) {
  
  # removes underrepresented sex and omits NA values
  brain_data <- brain_data |>
    filter(sex != "Intersex-Male") |>
    mutate(sex = factor(sex)) |>
    na.omit()
  
  if(filter_val2 == "All") {
    filter_var2 = NULL
    filter_val2 = NULL
  }
  
    # subset data
  if(!is.null(filter_var1) & !is.null(filter_val1) & is.null(filter_var2) & is.null(filter_var2)) {
    data_subset <- subset(
      brain_data, brain_data[[filter_var1]] == filter_val1)
  }
  if(!is.null(filter_var2) & !is.null(filter_var2)) {
    data_subset <- subset(
      brain_data, brain_data[[filter_var1]] == filter_val1 & brain_data[[filter_var2]] == filter_val2)
    
  }
  if(is.null(filter_var1) & is.null(filter_val1) & is.null(filter_var2) & is.null(filter_var2)) {
    data_subset <- brain_data
  }
  
  # creates xvar and yvar columns in dataset
  data_subset$xvar <- data_subset[[xcol]]
  data_subset$yvar <- data_subset[[ycol]]
  
  return(data_subset)
}
```

```{r}
#| label: model-cortical-area-function
#| context: setup
#| output: false

# Takes output of subset_data() function as argument
area_model <- function(data_subset) {
  
  # finds power transformation for gamlss model
  power <- gamlss::findPower(yvar, xvar, data = data_subset, k = 2)
  
  # build gamlss model for subsetted data
  model <- gamlss(
  yvar ~ pb(xvar^power) + gamlss::random(src_subject_id) + gamlss::random(site_id_l),
  sigma.formula = ~pb(xvar),
  tau.formula = ~xvar,
  nu.formula = ~xvar,
  family = BCPEo,
  data = data_subset
  )

  return(model)
}

```

```{r}
#| label: calculate-centiles-function
#| context: setup
#| output: false

# creates data frame of centiles for a given model object
# model_data *MUST* be the same data used to build model object
calculate_centiles <- function(
  # GAMLSS model object
  model,
  # data used to build model
  model_data,
  # x variable in model_data
  xcol,
  # y variable in model_data
  ycol,
  # centiles to calculate
  cent = c(97.5, 50, 2.5)
) {

xvar_ch <- deparse(xcol)
yvar_ch <- ycol
obj = model
x <- y <- NULL

xvar  <- get(xvar_ch, envir=as.environment(model_data))
fname <- obj$family[1]
qfun <- paste("q",fname,sep ="")
oxvar <- xvar[order(xvar)]
oyvar <- obj$y[order(xvar)]

lpar <- 4

ii <- 0
per <- rep(0, length(cent))
centile_matrix <- matrix(0, ncol = length(cent), nrow = dim(model_data)[1])
colnames(centile_matrix) <- cent

for(var in cent) {
  newcall <- call(qfun,var/100, mu=fitted(obj,"mu")[order(xvar)],
                     sigma=fitted(obj,"sigma")[order(xvar)],
                     nu=fitted(obj,"nu")[order(xvar)],
                     tau=fitted(obj,"tau")[order(xvar)]) 
    ii <- ii + 1
    centile_matrix[,ii] <- eval(newcall)
}

#yvar_ch <- paste(obj$call$formula[[2]])

lc <- length(cent)
centile_data <- data.frame(
  centile = centile_matrix,
  x = oxvar,
  y = oyvar)

return(centile_data)
}
```


```{r}
#| label: plot-area-centiles-function
#| context: setup
#| output: false

# returns ggplot for given model and data used to create model
centiles_plot <- function(
    # gamlss model object
    model,
    # data used to create gamlss model
    model_data,
    # x variable in data
    xcol,
    # y variable in data
    ycol,
    cent = c(2.5, 50, 97.5),
    # whether to include points on plot in addition to centile curves
    points = TRUE,
    race = "",
    sex = "",
    ylims = c(125000, 250000),
    region = "Total Brain"
    ) {
  
  centile_data <- calculate_centiles(model, model_data, xcol, ycol, cent)
  lc <- length(cent)
  c_names <- colnames(centile_data)
  line.size = 1.5
  line.col = hcl.colors(lc, palette = "Dark 2")
  line.type = rep(1, length(cent))
  
  # initialize ggplot object
  gg <- ggplot(data = centile_data)
  
  if(points) {
    gg <- gg + geom_point(aes(x = x, y = y),
             size = 1, alpha = 0.2, show.legend = FALSE, color = "gray")
  }
  for(i in 1:lc) {
    
    if(c_names[i] == "centile.50") {
      gg <- gg +
      geom_line(
        aes_string(x = "x", y = c_names[i]),
        color = line.col[i], linewidth = line.size)
    }
    
    else {
      gg <- gg +
      geom_line(
        aes_string(x = "x", y = c_names[i]),
        color = line.col[i], linetype = "dashed", linewidth = line.size)
    }
    
  }
  
  gg <- gg +
    scale_y_continuous(label = comma, limits = ylims) +
    scale_x_continuous(breaks = c(108,120,132,144, 156, 168,180,192),
                     labels = c(9,10,11,12,13,14,15,16)) +
    labs(x = "Age (Years)", y = TeX("Cortical Surface Area in $mm^2$"),
         title = paste(
           "Centiles for", region, "\nfor", race, sex, "Adolescents", sep = " "),
         subtitle = "Using Box-Cox Power Exponential Original Family")
    theme_minimal()  
  
  return(gg)
}
```

```{r}
#| label: download-models
#| eval: false

#define file name
sink('model_list.csv')

#print my_list to file
print(model_list)

#close external connection to file 
sink()

save(model_list, file = "area_model_list.RData")

```

```{r}
#| label: load-models
#| context: data
#| cache: true
#| cache-lazy: false

data_list <- list()
for(row in 1:nrow(demog_brain_combos)) {
  
  my_ycol <- demog_brain_combos[row,4]
  
  data_list[[row]] = subset_data(
    brain_data,
    xcol = "interview_age",
    ycol = my_ycol,
    filter_var1 = "sex",
    filter_val1 = demog_brain_combos[row, 1],
    filter_var2 = "race_ethnicity",
    filter_val2 = demog_brain_combos[row, 2])
}

setwd("~/Equitable Data Science REU/distributional-models")
load("area_model_list.RData")
```

```{r}
#| label: build-models
#| context: data
#| output: false
#| message: false
#| warning: false
#| eval: false
#| cache-lazy: false
#| cache: true

# create models for each combination of sex and race
model_list <- list()
demog_combos
for(row in 1:nrow(demog_brain_combos)) {
  print(
    paste("FITTING MODEL", row, ":", demog_brain_combos[row,2], demog_brain_combos[row,1], demog_brain_combos[row,3]))
  model_list[[row]] = area_model(data_subset = data_list[[row]])
}
```

# Home

##  {.sidebar width="25%"}

**Project Background**

## Column

```{r}
#| title: "Abstract"

print("Hello World")
```


```{r}
#| title: "Modeling Approach"

print("Hello World")
```


```{r}
#| title: "Table 1. Sample Demographics"

print("Hello World")
```

# Centile Estimation

Text here

## Column {width="50%"}

```{r}
#| title: "Input Individual Data to Determine Centile"

print("Hello World")

```

## Column {width="50%"}

```{r}
#| title: "Determine Centiles for Subpopulation"

print("Hello World")

```

# Cortical Thickness

# Cortical Surface Area

## {.toolbar}

```{r}
#| title: "Select Options"
#| layout-nrow: 2
#| layout-ncol: 1


# select y variable
selectInput(
  "area_var",
  "Select area of brain to model cortical surface area: ",
  area_vars,
  selected = c("whole brain ")
  )

# centile input boxes
checkboxGroupInput(
  "centiles_area",
  "Select Centiles to Include in Plot",
  c(0.4, 2, 2.5, 10, 25, 50, 75, 90, 97.5, 98, 99.6),
  selected = c(2.5, 50, 97.5),
  inline = TRUE
  )

```


## Row

```{r}
#| content: card-toolbar

race_levels <- c(levels(brain_data$race_ethnicity), "All")

# select race
selectInput(
  "race1",
  "Race",
  choices = race_levels,
  multiple = FALSE,
  selected = "All"
)

# select sex
selectInput(
  "sex1",
  "Sex",
  choices = c("Male", "Female"),
  multiple = FALSE,
  selected = "Female"
)
```

```{r}
#| title: "Plot 1"

plotOutput("area_centile_plot_1")

```


```{r}
#| content: card-toolbar

# select race
selectInput(
  "race2",
  "Race",
  choices = race_levels,
  multiple = FALSE,
  selected = "All"
)

# select sex
selectInput(
  "sex2",
  "Sex",
  choices = c("Male", "Female"),
  multiple = FALSE,
  selected = "Male"
)

```

```{r}
#| title: "Plot 2"

plotOutput("area_centile_plot_2")

```

```{r}
#| label: calculate-and-plot-centiles
#| context: server

output$area_centile_plot_1 <- renderPlot({
  
  demog_brain_combos <- as.data.frame(demog_brain_combos)
  race1 <- input$race1[1]
  sex1 <- input$sex1[1]
  centiles_to_plot <- as.numeric(input$centiles_area)
  region_label <- input$area_var[1]
  region_var <- area_labels$var_name[which(area_labels$var_label == region_label)]
  
  index <- which(demog_brain_combos$sex == sex1 &
                   demog_brain_combos$race_ethnicity == race1 &
                   demog_brain_combos$brain_location == region_label)
  
  y_limits <- c(as.numeric(demog_brain_combos[index, 5]), as.numeridemog_brain_combos[index, 6])
  
  model_data <- data_list[[index]]
  model_obj <- model_list[[index]]
  
  centiles_plot(
    model_obj,
    model_data,
    xcol = substitute(interview_age),
    ycol = region_var,
    cent = centiles_to_plot,
    race = race1,
    sex = sex1,
    ylims = y_limits,
    region = region_label
  )
  
})

output$area_centile_plot_2 <- renderPlot({
  
  demog_brain_combos <- as.data.frame(demog_brain_combos)
  race2 <- input$race2[1]
  sex2 <- input$sex2[1]
  centiles_to_plot <- as.numeric(input$centiles_area)
  region_label <- input$area_var[1]
  region_var <- area_labels$var_name[which(area_labels$var_label == region_label)]
  
  index <- which(demog_brain_combos$sex == sex2 & demog_brain_combos$race_ethnicity == race2 & demog_brain_combos$brain_location == region_label)
  
  y_limits <- c(as.numeric(demog_brain_combos[index, 5]), as.numeric(demog_brain_combos[index, 6]))
  
  model_data <- data_list[[index]]
  model_obj <- model_list[[index]]
  
  centiles_plot(
    model_obj,
    model_data,
    xcol = substitute(interview_age),
    ycol = region_var,
    cent = centiles_to_plot,
    race = race2,
    sex = sex2,
    ylims = y_limits,
    region = region_label
  )
  
})
```


