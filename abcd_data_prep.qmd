---
title: "ABCD Data Prep"
format: html
---

# Load Data and Packages

```{r}
#| label: load-packages
#| warning: false

library(tidyverse)
library(reshape2)
```

```{r}
#| label: input-vars-for-data
#| warning: false

# location of Box data directory
# for Shelby
data_dir <- 'C:/Users/queen/Box/ABCD Tabulated Data/5.1/core/'
setwd(data_dir)
# for Nicole
# data_dir <- NULL


# output directory
out_dir <- NULL
# output date
out_date <- NULL
# output initials
out_initials <- ""
# output wide format data
wide <- TRUE
# output variables for wide data format
wide_vars <- NULL 
```

```{r}
#| label: load-data
#| warning: false

# NOTE: must run entire code chunk
if(!is.null(data_dir)){
  setwd(data_dir)
}

# LOAD DATA
# Demographic variables and propensity weights
demog <- read.csv("abcd-general/abcd_p_demo.csv")
# Age in months, Site ID (ABCD Study Design Variables), Family ID
study_covars <- read.csv("abcd-general/abcd_y_lt.csv")
# desikan atlas, cortical thickness
dat.mri = read.csv('imaging/mri_y_smr_thk_dsk.csv')
# desikan atlas, cortical surface area
dat.mri.area = read.csv('imaging/mri_y_smr_area_dst.csv')
```

```{r}
#| label: select-relevant-vars

demog_long <- demog |>
  select(src_subject_id, starts_with("demo_race_a_p___")) |>
  # pivot race variables
  pivot_longer(cols = starts_with("demo_race_a_p___"),
               names_to = "race",
               values_to = "is_race",
               values_drop_na = TRUE,
               names_prefix = "demo_race_a_p___") |>
  filter(is_race != 0) |>
  mutate(race = fct_collapse(
    race,
    "White" = 10,
    "Black" = 11,
    "Native American" = 12,
    "Alaskan Native" = 13,
    "Native Hawaiian" = 14,
    "Guamanian" = 15,
    "Samoan" = 16,
    "Other Pacific Islander" = 17,
    "Asian Indian" = 18,
    "Chinese" = 19,
    "Filipino" = 20,
    "Japanese" = 21,
    "Korean" = 22,
    "Vietnamese" = 23,
    "Other Asian Race" = 24,
    "Other Race" = 25,
    "NA" = c(77, 99, 0)
  )) |>
  distinct() |>
  select(-is_race) |>
  group_by(src_subject_id) |>
  mutate(order = row_number())

# reformat wide
demog_wide <- demog_long |>
  pivot_wider(names_from = order, values_from = race, names_prefix = "race_")
```
