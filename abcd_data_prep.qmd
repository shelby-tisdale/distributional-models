---
title: "ABCD Data Prep"
format: html
---

# Load Data and Packages

```{r}
#| label: load-packages
#| warning: false

library(tidyverse)
library(reshape2)
```

```{r}
#| label: input-vars-for-data
#| warning: false

# location of Box data directory
# for Shelby
data_dir <- 'C:/Users/queen/Box/ABCD Tabulated Data/5.1/core/'

# for Nichole
# data_dir <- "/Users/nicholezhang/Library/CloudStorage/Box-Box/ABCD Tabulated Data/5.1/core"

setwd(data_dir)

# data_dir <- NULL


# output directory
out_dir <- NULL
# output date
out_date <- NULL
# output initials
out_initials <- ""
# output wide format data
wide <- TRUE
# output variables for wide data format
wide_vars <- NULL 
```

```{r}
#| label: load-data
#| warning: false

# NOTE: must run entire code chunk
if(!is.null(data_dir)){
  setwd(data_dir)
}

# LOAD DATA
# Demographic variables and propensity weights
demog <- read.csv("abcd-general/abcd_p_demo.csv")
# Age in months, Site ID (ABCD Study Design Variables), Family ID
study_covars <- read.csv("abcd-general/abcd_y_lt.csv")
# desikan atlas, cortical thickness
dat.mri = read.csv('imaging/mri_y_smr_thk_dsk.csv')
# desikan atlas, cortical surface area
dat.mri.area = read.csv('imaging/mri_y_smr_area_dst.csv')
```

```{r}
#| label: select-relevant-vars

demog_long <- demog |>
  # select relevant variables
   select(
     src_subject_id,
     eventname,
     starts_with("demo_brthdat_v2"),
     demo_sex_v2,
     starts_with("demo_gender_id_v2"),
     starts_with("demo_race_a_p___"),
     starts_with("demo_ethn"),
     demo_prnt_years_us_v2,
     starts_with("demo_prnt_marital_v2"),
     starts_with("demo_prnt_ed_v2"),
     starts_with("demo_prnt_income_v2"),
     starts_with("demo_prnt_prtnr_v2"),
     starts_with("demo_prnt_prtnr_bio"),
     starts_with("demo_prnt_prtnr_adopt"),
     starts_with("demo_prtnr_ed_v2"),
     starts_with("demo_prtnr_income_v2"),
     starts_with("demo_comb_income_v2"),
     starts_with("demo_med_insur"),
     race_ethnicity,
     acs_raked_propensity_score
     ) |>
  # pivot race variables
  pivot_longer(cols = starts_with("demo_race_a_p___"),
               names_to = "race",
               values_to = "is_race",
               values_drop_na = TRUE,
               names_prefix = "demo_race_a_p___") |>
  filter(is_race != 0) |>
  mutate(race = fct_collapse(
    race,
    "White" = 10,
    "Black" = 11,
    "Native American" = 12,
    "Alaskan Native" = 13,
    "Native Hawaiian" = 14,
    "Guamanian" = 15,
    "Samoan" = 16,
    "Other Pacific Islander" = 17,
    "Asian Indian" = 18,
    "Chinese" = 19,
    "Filipino" = 20,
    "Japanese" = 21,
    "Korean" = 22,
    "Vietnamese" = 23,
    "Other Asian Race" = 24,
    "Other Race" = 25,
    "NA" = c(77, 99, 0)
  )) |>
  distinct() |>
  select(-is_race) |>
  group_by(src_subject_id) |>
  mutate(order = row_number())

# reformat wide and continue cleaning
demog_wide <- demog_long |>
  pivot_wider(names_from = order, values_from = race, names_prefix = "race_") |>
  #clean hispanic origin variable 
  mutate(
    hispanic_origin = case_match(
      demo_ethn_v2,
      1 ~ 1,
      2 ~ 0,
      .default = NA),
    hispanic_origin_spec = case_match(
    demo_ethn2_v2, 
    10 ~ "Puerto Rican", 
    12 ~ "Dominican",
    13 ~ "Mexican", 
    14 ~ "Mexican American", 
    15 ~ "Chicano", 
    18 ~ "Cuban", 
    19 ~ "Cuban American", 
    20 ~ "Central or South American", 
    40 ~ "Other Latin American origin", 
    41 ~ "Other Hispanic", 
    .default = NA),
    # clean age variable
    age = trunc(demo_brthdat_v2) # remove decimals 
    ) |>
  select(-starts_with("demo_ethn"))
```
