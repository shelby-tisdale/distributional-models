---
title: "ABCD Data Prep"
format: html
---

# Load Data and Packages

```{r}
#| label: load-packages
#| warning: false

library(tidyverse)
library(reshape2)
```

```{r}
#| label: input-vars-for-data
#| warning: false

# location of Box data directory
# for Shelby
data_dir <- 'C:/Users/queen/Box/ABCD Tabulated Data/5.1/core/'

# for Nichole
# data_dir <- "/Users/nicholezhang/Library/CloudStorage/Box-Box/ABCD Tabulated Data/5.1/core"

setwd(data_dir)

# data_dir <- NULL


# output directory
out_dir <- NULL
# output date
out_date <- NULL
# output initials
out_initials <- ""
# output wide format data
wide <- TRUE
# output variables for wide data format
wide_vars <- NULL 
```

```{r}
#| label: load-data
#| warning: false

# NOTE: must run entire code chunk
if(!is.null(data_dir)){
  setwd(data_dir)
}

# LOAD DATA
# Demographic variables and propensity weights
demog <- read.csv("abcd-general/abcd_p_demo.csv", na.strings = c(999, 777))
# Age in months, Site ID (ABCD Study Design Variables), Family ID
study_covars <- read.csv("abcd-general/abcd_y_lt.csv")
# desikan atlas, cortical thickness
dat.mri = read.csv('imaging/mri_y_smr_thk_dsk.csv')
# desikan atlas, cortical surface area
dat.mri.area = read.csv('imaging/mri_y_smr_area_dst.csv')
```

```{r}
#| label: select-relevant-vars

demog_clean <- demog |>
  filter(eventname %in% c(
    "baseline_year_1_arm_1",
    "2_year_follow_up_y_arm_1",
    "4_year_follow_up_y_arm_1")) |>
  # select relevant variables
   select(
     src_subject_id,
     eventname,
     starts_with("demo_brthdat_v2"),
     demo_sex_v2,
     starts_with("demo_gender_id_v2"),
     starts_with("demo_race_a_p___"),
     starts_with("demo_ethn"),
     demo_prnt_years_us_v2,
     starts_with("demo_prnt_marital_v2"),
     starts_with("demo_prnt_ed_v2"),
     starts_with("demo_prnt_income_v2"),
     starts_with("demo_prnt_prtnr_v2"),
     starts_with("demo_prnt_prtnr_bio"),
     starts_with("demo_prnt_prtnr_adopt"),
     starts_with("demo_prtnr_ed_v2"),
     starts_with("demo_prtnr_income_v2"),
     starts_with("demo_comb_income_v2"),
     starts_with("demo_med_insur"),
     starts_with("demo_ethn"),
     race_ethnicity,
     acs_raked_propensity_score
     ) 

demog_baseline_long <- demog_clean |>
  # pivot race variables
  pivot_longer(cols = starts_with("demo_race_a_p___"),
               names_to = "race",
               values_to = "is_race",
               values_drop_na = TRUE,
               names_prefix = "demo_race_a_p___") |>
 # select(race, is_race, src_subject_id) |>
  filter(is_race != 0 | is.na(is_race)) |>
  mutate(race = fct_collapse(
    race,
    "White" = 10,
    "Black" = 11,
    "Native American" = 12,
    "Alaskan Native" = 13,
    "Native Hawaiian" = 14,
    "Guamanian" = 15,
    "Samoan" = 16,
    "Other Pacific Islander" = 17,
    "Asian Indian" = 18,
    "Chinese" = 19,
    "Filipino" = 20,
    "Japanese" = 21,
    "Korean" = 22,
    "Vietnamese" = 23,
    "Other Asian Race" = 24,
    "Other Race" = 25,
    "NA" = c(77, 99, 0)
  )) |>
  distinct() |>
  group_by(src_subject_id) |>
  mutate(order = row_number()) |>
  ungroup()

# reformat wide and continue cleaning
demog_baseline_wide <- demog_baseline_long |>
  pivot_wider(names_from = order, values_from = race, values_fill = NA, names_prefix = "race_") |>
   #clean hispanic origin variable 
  mutate(
    hispanic_origin = case_match(
      demo_ethn_v2,
      1 ~ 1,
      2 ~ 0,
      .default = NA),
    hispanic_origin_spec = case_match(
    demo_ethn2_v2, 
    10 ~ "Puerto Rican", 
    12 ~ "Dominican",
    13 ~ "Mexican", 
    14 ~ "Mexican American", 
    15 ~ "Chicano", 
    18 ~ "Cuban", 
    19 ~ "Cuban American", 
    20 ~ "Central or South American", 
    40 ~ "Other Latin American origin", 
    41 ~ "Other Hispanic", 
    .default = NA),
    sex = factor(demo_sex_v2),
    sex = fct_recode(
      sex,
      "Male" = "1",
      "Female" = "2",
      "Intersex-Male" = "3"
    )) |>
  rename(
    parent_years_us_baseline = demo_prnt_years_us_v2
  ) |>
  select(src_subject_id, race_1:race_5, hispanic_origin, hispanic_origin_spec, sex, parent_years_us_baseline)

demog_clean <- demog_clean |>
 mutate(
    # clean age variable
    age = case_when(
      eventname == "baseline_year_1_arm_1" ~ trunc(demo_brthdat_v2), # remove decimals 
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ trunc(demo_brthdat_v2_l)),
    gender_id = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_gender_id_v2,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_gender_id_v2_l),
    gender_id = case_match(
      gender_id,
      1 ~ "Male",
      2 ~ "Female",
      3 ~ "Trans male",
      4 ~ "Trans female",
      5 ~ "Genderqueer",
      6 ~ "Other"
    ),
    parent_marital_status = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_marital_v2,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_marital_v2_l
    ),
    parent_marital_status = case_match(
      parent_marital_status,
      1 ~ "Married",
      2 ~ "Widowed",
      3 ~ "Divorced",
      4 ~ "Separated",
      5 ~ "Never Married",
      6 ~ "Living with Partner"),
    parent_ed = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_ed_v2,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_ed_v2_2yr_l
    ),
    parent_ed = case_match(
      parent_ed,
      0 ~ "Never attended / Kindergarten",
      1 ~ "1st Grade",
      2 ~ "2nd Grade",
      3 ~ "3rd Grade",
      4 ~ "4th Grade",
      5 ~ "5th Grade",
      6 ~ "6th Grade",
      7 ~ "7th Grade",
      8 ~ "8th Grade",
      9 ~ "9th Grade",
      10 ~ "10th Grade",
      11 ~ "11th Grade",
      12 ~ "12th Grade - No Diploma",
      13 ~ "High School Graduate",
      14 ~ "GED or Equivalent",
      16 ~ "Associate Degree: Occupational, Technical or Vocational",
      17 ~ "Associate Degree: Academic Program",
      18 ~ "Bachelor's Degree",
      19 ~ "Master's Degree",
      20 ~ "Professional School Degree",
      21 ~ "Doctoral Degree",
      22 ~ "Less than 1 year of college",
      23 ~ "One year or more of college credit - no degree"
    ),
    parent_income = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_income_v2,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_income_v2_l),
    parent_income = case_match(
      parent_income,
        1 ~ "Less than $5,000",
        2 ~ "$5,000 to $11,999",
        3 ~ "$12,000 to $15,999",
        4 ~ "$16,000 to $24,999",
        5 ~ "$25,000 to $34,999",
        6 ~ "$35,000 to $49,999",
        7 ~ "$50,000 to $74,999",
        8 ~ "$75,000 to $99,999",
        9 ~ "$100,000 to $199,999",
        10 ~ "$200,000 and over"
      ),
    parent_partner = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_prtnr_v2,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_prtnr_v2_l),
    parent_partner = if_else(parent_partner == 1, 1, 0),
    parent_partner_bio = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_prtnr_bio,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_prtnr_bio_l),
    parent_partner_bio = if_else(parent_partner_bio == 1, 1, 0),
    parent_partner_adopt = case_when(
      eventname == "baseline_year_1_arm_1" ~ demo_prnt_prtnr_adopt,
      eventname %in% c(
        "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"
        ) ~ demo_prnt_prtnr_adopt_l),
    parent_partner_adopt = if_else(parent_partner_adopt == 1, 1, 0)
    ) |>
  select(
    -demo_prnt_years_us_v2,
    -starts_with("demo_prnt_prtnr"),
    -starts_with("demo_ethn"),
    -starts_with("demo_race"),
    -starts_with("demo_brthdat"),
    -starts_with("demo_gender_id"),
    -demo_sex_v2,
    -starts_with("demo_prnt_marital"),
    -starts_with("demo_prnt_ed"),
    -starts_with("demo_prnt_income")) |>
  left_join(demog_baseline_wide, join_by("src_subject_id"))
```

```{r}

table(demog_clean$demo_prnt_ed_v2_l)
demog_clean |>
  filter(!is.na(demo_prnt_ed_v2_l))
```
